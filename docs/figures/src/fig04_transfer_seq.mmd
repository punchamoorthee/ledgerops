%%{init: {"theme":"neutral","themeVariables":{
  "fontFamily":"Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto",
  "primaryColor":"#40826D","primaryBorderColor":"#40826D","primaryTextColor":"#0a0a0a",
  "lineColor":"#40826D","tertiaryColor":"#ffffff"}}}%%
sequenceDiagram
  autonumber
  participant C as Client
  participant A as API (Go)
  participant D as PostgreSQL

  Note over A,D: Txn: Read Committed + fixed lock order (debit → credit)

  C->>A: POST /transfers (Idempotency-Key: K)
  activate A
  A->>D: BEGIN
  activate D
  A->>D: SELECT ... FOR UPDATE (debit)
  A->>D: SELECT ... FOR UPDATE (credit)
  A->>D: INSERT ledger_entries (+version)
  A->>D: COMMIT
  deactivate D
  A-->>C: 202 Accepted
  Note over C,A: Location: /transfers/{id}
  deactivate A

  loop Poll with backoff + jitter
    C->>A: GET /transfers/{id}
    alt Not completed yet
      A-->>C: 202 Accepted
    else Completed
      A-->>C: 200 OK (result)
    end
  end

  alt Lost response after COMMIT
    Note over C,A: Client retries POST with same K
    C->>A: POST /transfers (K)
    A->>D: SELECT idempotency_keys WHERE key = K
    alt status = completed
      A-->>C: 200 OK (replay stored result)
    else status = in_progress
      A-->>C: 202 Accepted
      Note over C,A: Location: /transfers/{id}
    end
  end

  alt Network timeout on POST/GET
    Note over C: Unknown outcome → retry with K (exp backoff + jitter)
  end