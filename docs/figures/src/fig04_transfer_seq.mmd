%%{init: {"theme":"neutral","themeVariables":{
  "fontFamily":"Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto",
  "primaryColor":"#40826D","primaryBorderColor":"#40826D","primaryTextColor":"#0a0a0a",
  "lineColor":"#40826D","tertiaryColor":"#ffffff"}}}%%
sequenceDiagram
  autonumber
  participant C as Client
  participant A as API (Go)
  participant D as PostgreSQL

  Note over A,D: Txn Read Committed and fixed lock order
  Note over A,D: Sort account UUIDs ascending then lock

  C->>A: POST /transfers (Idempotency-Key K)
  A->>D: BEGIN
  A->>D: SELECT ... FOR UPDATE lock accounts asc
  A->>D: INSERT into ledger_entries and bump version
  A->>D: UPSERT idempotency_keys with K status=completed store response
  A->>D: COMMIT
  A-->>C: 200 OK result

  alt Retry with same K
    C->>A: POST /transfers (K)
    A->>D: SELECT * FROM idempotency_keys WHERE key=K
    alt status is completed
      A-->>C: 200 OK replay stored result
    else status is in_progress
      A-->>C: 409 Conflict
    end
  end